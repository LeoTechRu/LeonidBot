{% set header_user = current_user if (current_user is defined and current_user) else (user if user is defined else None) %}
{% set header_role = current_role_name if current_role_name is defined else (role_name if role_name is defined else '') %}
<div class="top-left">
    <a class="brand" href="/">
      <img class="brand-mark" src="{{ url_for('static', path='img/brand/leonidpro-mark.svg') }}" alt="LeonidPro" width="24" height="24" loading="lazy">
      <span class="brand-type">LeonidPro</span>
    </a>
    <button id="nav-toggle" class="nav-toggle" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é" aria-expanded="false">‚ò∞</button>
    {# removed old emoji logo and project-name link #}
</div>
<div class="top-center">
    <h2 class="page-title">{{ page_title }}</h2>
</div>
<div class="top-right">
    <div class="bot-menu"><a href="{{ BOT_LANDING_URL }}" target="_blank">Bot</a></div>
    {% if header_user %}
        <div id="compact-toggle" class="profile-icon">üóú</div>
        <div class="profile-menu">
            <div id="profile-button" class="profile-icon role-{{ header_role|lower }}">üë§</div>
            <div id="profile-dropdown" class="dropdown-menu hidden">
                <div class="role">
                    –†–æ–ª—å:
                    <button type="button" class="role-badge" data-role="{{ header_role }}">{{ header_role }}</button>
                </div>
                {% if header_user.telegram_id is defined %}
                <a href="/profile/{{ header_user.telegram_id }}">–ü—Ä–æ—Ñ–∏–ª—å</a>
                {% else %}
                <a href="/profile/{{ header_user.username }}">–ü—Ä–æ—Ñ–∏–ª—å</a>
                {% endif %}
                <a href="/settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
                {% if is_admin %}
                <a href="/admin">–ê–¥–º–∏–Ω</a>
                {% endif %}
                <a href="/auth/logout" data-method="post">–í—ã–π—Ç–∏</a>
            </div>
        </div>
    {% else %}
        <nav class="guest-menu">
            <a href="/auth">–í—Ö–æ–¥</a>
        </nav>
    {% endif %}
</div>

{# –û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º —Å —É—á—ë—Ç–æ–º —Ä–æ–ª–µ–π #}
{% set _role = (header_role|lower) if header_role else '' %}
{% set _path = request.url.path if request and request.url else '' %}
{% set _is_banned = (_role == 'ban') %}
{% set _is_admin = (_role == 'admin') %}
{% set _is_moderator = (_role == 'moderator') %}
{% set _is_multi = (_role in ['multiplayer','moderator','admin']) %}
{% set _is_single = (_role in ['single','multiplayer','moderator','admin']) %}

{% if not _is_banned %}
<nav class="main-nav">
  <a href="/" class="{{ 'active' if _path == '/' else '' }}">–î–∞—à–±–æ—Ä–¥</a>
  {% if _is_single %}
    <a href="/tasks" class="{{ 'active' if _path.startswith('/tasks') else '' }}">–ó–∞–¥–∞—á–∏</a>
    <a href="/reminders" class="{{ 'active' if _path.startswith('/reminders') else '' }}">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</a>
    <a href="/calendar" class="{{ 'active' if _path.startswith('/calendar') else '' }}">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</a>
    <a href="/time" class="{{ 'active' if _path.startswith('/time') else '' }}">–í—Ä–µ–º—è</a>
    <a href="/notes" class="{{ 'active' if _path.startswith('/notes') else '' }}">–ó–∞–º–µ—Ç–∫–∏</a>
  {% endif %}
  {# –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã (multi): –≥—Ä—É–ø–ø—ã/–ø—Ä–æ–µ–∫—Ç—ã ‚Äî –ø–æ–∑–∂–µ #}
  {# {% if _is_multi %}<a href="/projects" class="{{ 'active' if _path.startswith('/projects') else '' }}">–ü—Ä–æ–µ–∫—Ç—ã</a>{% endif %} #}
  <span class="nav-fill"></span>
</nav>
{% endif %}

<script>
// Admin users: inject search and role filters (idempotent)
(function(){
  // Mobile menu toggle
  function mobileMenu(){
    const toggle = document.getElementById('nav-toggle');
    const nav = document.querySelector('nav.main-nav');
    if (!toggle || !nav) return;
    function close(){ nav.classList.remove('open'); toggle.setAttribute('aria-expanded','false'); }
    function open(){ nav.classList.add('open'); toggle.setAttribute('aria-expanded','true'); }
    toggle.addEventListener('click', (e)=>{
      e.stopPropagation();
      const isOpen = nav.classList.contains('open');
      isOpen ? close() : open();
    });
    // Close on link click or outside click
    nav.addEventListener('click', (e)=>{ if (e.target.closest('a')) close(); });
    document.addEventListener('click', (e)=>{
      if (!nav.contains(e.target) && e.target !== toggle) close();
    });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') close(); });
  }
  function create(tag, attrs, ...children){
    const el = document.createElement(tag);
    if (attrs) Object.entries(attrs).forEach(([k,v])=>{
      if (k === 'style' && typeof v === 'object') Object.assign(el.style, v);
      else if (k in el) el[k] = v; else el.setAttribute(k, v);
    });
    children.forEach(ch=> el.appendChild(typeof ch === 'string' ? document.createTextNode(ch) : ch));
    return el;
  }

  function setupWebFilters(section){
    if (!section || section.querySelector('#web-search')) return;
    const roles = Array.from(document.querySelectorAll('#users-web select.web-role option'))
      .map(o=>o.value).filter((v,i,arr)=> arr.indexOf(v)===i);
    const controls = create('div', {style: {margin: '8px 0', display: 'flex', gap: '8px', alignItems: 'center'}},
      create('input', {id: 'web-search', type: 'text', placeholder: '–ü–æ–∏—Å–∫ –ø–æ username, —Å–≤—è–∑–∞–Ω–Ω—ã–º TG', style: {flex: '1', padding: '6px 8px'}}),
      create('label', {htmlFor: 'web-role-filter'}, '–†–æ–ª—å:'),
      (function(){
        const sel = create('select', {id: 'web-role-filter', style: {padding: '6px 8px'}});
        sel.appendChild(create('option', {value: ''}, '–í—Å–µ'));
        roles.forEach(r=> sel.appendChild(create('option', {value: r}, r)));
        return sel;
      })()
    );
    const h1 = section.querySelector('h1');
    if (h1) h1.insertAdjacentElement('afterend', controls); else section.prepend(controls);

    function apply(){
      const q = (section.querySelector('#web-search').value || '').trim().toLowerCase();
      const role = section.querySelector('#web-role-filter').value || '';
      section.querySelectorAll('table tbody tr').forEach(row=>{
        const cells = row.querySelectorAll('td');
        if (!cells.length) return;
        const username = (cells[1]?.textContent || '').toLowerCase();
        const tg = (cells[2]?.textContent || '').toLowerCase();
        const rsel = row.querySelector('select.web-role');
        const r = (rsel?.value || '').toLowerCase();
        const matchText = !q || username.includes(q) || tg.includes(q);
        const matchRole = !role || r === role.toLowerCase();
        row.style.display = (matchText && matchRole) ? '' : 'none';
      });
    }
    section.querySelector('#web-search').addEventListener('input', apply);
    section.querySelector('#web-role-filter').addEventListener('change', apply);
    apply();
  }

  function setupTgFilters(section){
    if (!section || section.querySelector('#tg-search')) return;
    const roles = Array.from(document.querySelectorAll('#users select.tg-role option'))
      .map(o=>o.value).filter((v,i,arr)=> arr.indexOf(v)===i);
    const controls = create('div', {style: {margin: '8px 0', display: 'flex', gap: '8px', alignItems: 'center'}},
      create('input', {id: 'tg-search', type: 'text', placeholder: '–ü–æ–∏—Å–∫ –ø–æ ID, username, –∏–º–µ–Ω–∏', style: {flex: '1', padding: '6px 8px'}}),
      create('label', {htmlFor: 'tg-role-filter'}, '–†–æ–ª—å:'),
      (function(){
        const sel = create('select', {id: 'tg-role-filter', style: {padding: '6px 8px'}});
        sel.appendChild(create('option', {value: ''}, '–í—Å–µ'));
        roles.forEach(r=> sel.appendChild(create('option', {value: r}, r)));
        return sel;
      })()
    );
    const h1 = section.querySelector('h1');
    if (h1) h1.insertAdjacentElement('afterend', controls); else section.prepend(controls);

    function apply(){
      const q = (section.querySelector('#tg-search').value || '').trim().toLowerCase();
      const role = section.querySelector('#tg-role-filter').value || '';
      section.querySelectorAll('table tbody tr').forEach(row=>{
        const cells = row.querySelectorAll('td');
        if (!cells.length) return;
        const id = (cells[0]?.textContent || '').toLowerCase();
        const username = (cells[1]?.textContent || '').toLowerCase();
        const first = (cells[2]?.textContent || '').toLowerCase();
        const last = (cells[3]?.textContent || '').toLowerCase();
        const rsel = row.querySelector('select.tg-role');
        const r = (rsel?.value || '').toLowerCase();
        const matchText = !q || id.includes(q) || username.includes(q) || first.includes(q) || last.includes(q);
        const matchRole = !role || r === role.toLowerCase();
        row.style.display = (matchText && matchRole) ? '' : 'none';
      });
    }
    section.querySelector('#tg-search').addEventListener('input', apply);
    section.querySelector('#tg-role-filter').addEventListener('change', apply);
    apply();
  }

  function init(){
    mobileMenu();
    const web = document.getElementById('users-web');
    const tg = document.getElementById('users');
    if (web) setupWebFilters(web);
    if (tg) setupTgFilters(tg);
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
})();
</script>
