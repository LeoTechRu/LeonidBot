{% extends "layout.html" %}
{% block title %}Вход{% endblock %}
{% block content %}
  <div class="ui-layout">
    <h2>Вход</h2>
    <form class="ui-form" method="post" action="/auth/login">
      <label>Username</label>
      <input type="text" name="username" required>
      <label>Password</label>
      <input type="password" name="password" required>
      <button type="submit" class="button">Войти</button>
    </form>

    <h3>Или войдите через Telegram</h3>
    <div>
      <script async src="https://telegram.org/js/telegram-widget.js?22"
              data-telegram-login="{{ bot_username }}"
              data-size="large"
              data-userpic="false"
              data-onauth="onTelegramAuth(user)"
              data-request-access="write">
      </script>
    </div>
  </div>

  <script>
  async function onTelegramAuth(user) {
    const form = new URLSearchParams();
    for (const [k,v] of Object.entries(user)) { form.append(k, v); }
    const resp = await fetch('/auth/tg/callback', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: form.toString(),
      credentials: 'same-origin'
    });
    if (resp.redirected) {
      window.location = resp.url;
    } else {
      alert('Telegram account not linked');
    }
  }
  </script>
{% endblock %}

