# Инструкции для Codex (agent)

Этот файл предназначен для «агента», который автоматически решает задачи в репозитории LeonidPro. Следуйте этим правилам, чтобы избегать лишних задержек и ошибок при выполнении любых задач.

## Подготовка окружения

Работайте из корня проекта. Если виртуальное окружение ещё не создано, создайте его и активируйте:

```bash
python -m venv venv
source venv/bin/activate
```

Перед выполнением любой задачи обязательно устанавливайте зависимости из файла `requirements.txt`:

```bash
pip install --quiet -r requirements.txt
```

Если вы добавляете новые зависимости, фиксируйте их в `requirements.txt` и повторно запускайте установку.

Используйте файл `.env` (или `.env.example` как шаблон) для переменных окружения. Убедитесь, что параметры `BOT_TOKEN`, `BOT_USERNAME`, `WEB_PUBLIC_URL`, `SESSION_MAX_AGE`, `ADMIN_TELEGRAM_IDS` и другие заданы перед запуском бота или веб-приложения.

### Тестовая база данных PostgreSQL

Для корректного прохождения тестов требуется запущенный экземпляр PostgreSQL.

1. Поднимите сервер PostgreSQL локально (через `pg_ctlcluster`, Docker или иной способ) и убедитесь, что он принимает подключения на `127.0.0.1:5432`.
2. Создайте временный файл `.env.test` со строками подключения и экспортируйте переменные:
   ```bash
   cat > .env.test <<'EOF'
   DB_HOST=127.0.0.1
   DB_USER=postgres
   DB_PASSWORD=postgres
   DB_NAME=postgres
   EOF
   set -a; source .env.test; set +a
   ```
   Файл `.env.test` уже добавлен в `.gitignore` и не должен попадать в репозиторий.
3. Запустите тесты: `pytest -q`.
4. По завершении остановите сервер PostgreSQL.

## Архитектура и структура кода

Проект разделён на подсистемы. Соблюдайте это разделение, чтобы не дублировать бизнес‑логику:

- `core/` — общие модели, сервисы, утилиты и логирование. Весь код, разделяемый `web` и `bot`, храните здесь.
- `bot/` — код Telegram‑бота: хендлеры, состояния FSM, роутеры aiogram. Не дублируйте в боте логику, которая должна быть в `core`.
- `web/` — FastAPI‑приложение: маршруты, шаблоны, зависимости. Общие функции и сервисы импортируются из `core`.
- `tests/` — тесты для всего проекта. Актуализируйте их при внесении изменений в логику и выполняйте для проверки корректности.

Если функция используется и ботом, и веб‑частью, создайте сервис в `core/services` и обращайтесь к нему отовсюду.

## Выполнение задач

1. Обновите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
2. Поддерживайте чистое рабочее дерево и пишите осмысленные коммит‑сообщения, аргументируя внесённые изменения.
3. По завершении любой задачи запускайте тесты:
   ```bash
   pytest -q
   ```
   Тесты находятся в каталоге `tests`. Исправляйте все ошибки перед завершением работы.
4. После прохождения тестов обновите сопутствующие файлы: `requirements.txt` (если добавлены новые пакеты), `.env.example` (при появлении новых переменных), а в `README.md` зафиксируйте внедрённые изменения и планы на следующие шаги.

## Стиль кодирования

- Используйте асинхронные функции (`async/await`) там, где это уже используется.
- Формируйте строки с помощью f‑строк.
- Давайте понятные имена переменным и функциям на английском языке.
- Пишите типы (аннотации), где это возможно.
- Прогоняйте линтер (flake8 или аналог) перед коммитом.

## Именование таблиц

- Название каждой таблицы начинается с названия модуля (группы), которому она принадлежит.
- Таблицы, связанные с пользователями, используют префикс `users_` (например, `users_tg`, `users_web`).

## UI/UX

- Шапка приложения должна быть единой для всех страниц.
- Название текущего модуля или страницы выводится по центру основной шапки.
- Внутри страниц не используйте вложенных шапок.
- Переадресацию на отдельные страницы используйте только для новых модулей, отличающихся от базового функционала.

## Деплой и сервисы

Unit-файлы systemd находятся в `deploy/systemd`. Для установки или обновления сервисов используйте `./deploy/install_services.sh`, который загружает переменные из `.env` и перезапускает `leonidbot-bot` и `leonidbot-web`. Автодеплой настроен через workflow `.github/workflows/deploy.yml` (нужны secrets `VPS_HOST`, `VPS_USER`, `VPS_KEY`).

## Финальный шаг

Каждый раз, завершив задачу, выполняйте:

```bash
source venv/bin/activate
pip install --quiet -r requirements.txt
pytest -q
```

Эти действия обновят виртуальную среду и убедят вас в том, что все тесты проходят. Только после успешного прохождения тестов можно считать задачу выполненной.

## Документирование изменений

После выполнения любой задачи:

- Обновите `README.md`, кратко описав внедрённые изменения.
- В том же файле зафиксируйте планы на следующие шаги.

Соблюдайте заложенную архитектуру: весь общий код для `web` и `bot` должен располагаться в каталоге `core/`.

---

# LeonidPro — правила нейминга

- Название проекта: **LeonidPro**.
- Основной домен продукта: **https://leonid.pro/**.
- Телеграм-бот: **@LeonidBot** — это часть проекта LeonidPro.
- Лендинг бота: **https://leonid.pro/bot** (превью/инструкции по использованию).
- В текстах UI, документации и мета-данных “LeonidPro” использовать **только** как имя Telegram-бота
  (например: «Подключите бота @LeonidBot»).
- Бренд и заголовки страниц должны использовать **LeonidPro**.
- Все новые ссылки на продукт по умолчанию ведут на **https://leonid.pro/**,
  а ссылки, связанные именно с ботом — на **https://leonid.pro/bot** или @LeonidBot.
- При необходимости указывать base URL в конфиге: `WEB_PUBLIC_URL=https://leonid.pro`.

