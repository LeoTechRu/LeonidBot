# Инструкции для Codex (agent)

Этот файл предназначен для «агента», который автоматически решает задачи в репозитории LeonidBot. Следуйте этим правилам, чтобы избегать лишних задержек и ошибок при выполнении любых задач.

## Подготовка окружения

Работайте из корня проекта. Если виртуальное окружение ещё не создано, создайте его и активируйте:

```bash
python -m venv venv
source venv/bin/activate
```

Перед выполнением любой задачи обязательно устанавливайте зависимости из файла `requirements.txt`:

```bash
pip install --quiet -r requirements.txt
```

Если вы добавляете новые зависимости, фиксируйте их в `requirements.txt` и повторно запускайте установку.

Используйте файл `.env` (или `.env.example` как шаблон) для переменных окружения. Убедитесь, что параметры `BOT_TOKEN`, `TELEGRAM_BOT_USERNAME`, `PUBLIC_BASE_URL`, `SESSION_MAX_AGE`, `ADMIN_TELEGRAM_IDS` и другие заданы перед запуском бота или веб-приложения.

## Архитектура и структура кода

Проект разделён на подсистемы. Соблюдайте это разделение, чтобы не дублировать бизнес‑логику:

- `core/` — общие модели, сервисы, утилиты и логирование. Весь код, разделяемый `web` и `bot`, храните здесь.
- `bot/` — код Telegram‑бота: хендлеры, состояния FSM, роутеры aiogram. Не дублируйте в боте логику, которая должна быть в `core`.
- `web/` — FastAPI‑приложение: маршруты, шаблоны, зависимости. Общие функции и сервисы импортируются из `core`.
- `tests/` — тесты для всего проекта. Актуализируйте их при внесении изменений в логику и выполняйте для проверки корректности.

Если функция используется и ботом, и веб‑частью, создайте сервис в `core/services` и обращайтесь к нему отовсюду.

## Выполнение задач

1. Обновите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
2. Поддерживайте чистое рабочее дерево и пишите осмысленные коммит‑сообщения, аргументируя внесённые изменения.
3. По завершении любой задачи запускайте тесты:
   ```bash
   pytest -q
   ```
   Тесты находятся в каталоге `tests`. Исправляйте все ошибки перед завершением работы.
4. После прохождения тестов обновите сопутствующие файлы: `requirements.txt` (если добавлены новые пакеты), `.env.example` (при появлении новых переменных), а в `README.md` зафиксируйте внедрённые изменения и планы на следующие шаги.

## Стиль кодирования

- Используйте асинхронные функции (`async/await`) там, где это уже используется.
- Формируйте строки с помощью f‑строк.
- Давайте понятные имена переменным и функциям на английском языке.
- Пишите типы (аннотации), где это возможно.
- Прогоняйте линтер (flake8 или аналог) перед коммитом.

## UI/UX

- Шапка приложения должна быть единой для всех страниц.
- Название текущего модуля или страницы выводится по центру основной шапки.
- Внутри страниц не используйте вложенных шапок.
- Переадресацию на отдельные страницы используйте только для новых модулей, отличающихся от базового функционала.

## Деплой и сервисы

Unit-файлы systemd находятся в `deploy/systemd`. Для установки или обновления сервисов используйте `./deploy/install_services.sh`, который загружает переменные из `.env` и перезапускает `leonidbot-bot` и `leonidbot-web`. Автодеплой настроен через workflow `.github/workflows/deploy.yml` (нужны secrets `VPS_HOST`, `VPS_USER`, `VPS_KEY`).

## Финальный шаг

Каждый раз, завершив задачу, выполняйте:

```bash
source venv/bin/activate
pip install --quiet -r requirements.txt
pytest -q
```

Эти действия обновят виртуальную среду и убедят вас в том, что все тесты проходят. Только после успешного прохождения тестов можно считать задачу выполненной.

## Документирование изменений

После выполнения любой задачи:

- Обновите `README.md`, кратко описав внедрённые изменения.
- В том же файле зафиксируйте планы на следующие шаги.

Соблюдайте заложенную архитектуру: весь общий код для `web` и `bot` должен располагаться в каталоге `core/`.
