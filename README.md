# LeonidBot
- Пет-проект для изучения возможностей Telegram-ботов. [LeonidBot.t.me](https://LeonidBot.t.me)
- Бот должен включать в себя различные полезные утилиты (таск-система, тайм-менеджер, интеграции с календарями, напоминалки, управление TG-группами)
- Для усложнения задачи поставил себе цель прикрутить веб-морду с авторизацией через Telegram.
- В качестве веб морды буду использовать Flask/FastApi/Django.

## Структура проекта
- `bot/` – Telegram-бот и его обработчики
- `web/` – веб-приложение и связанные утилиты
- `core/` – общие модули (`db.py`, `models.py`, `services/`)

## Правила разработки
- `/core` содержит общие модели, сервисы, утилиты и логирование;
- `/bot` хранит только код Telegram-бота (хендлеры, FSM-состояния, роутинг aiogram);
- `/web` содержит только FastAPI-роуты, шаблоны и зависимости;
- новую общую бизнес-логику нужно выносить в `/core`, чтобы переиспользовать её в боте и веб-интерфейсе.

## Журнал изменений и планы
### Последние изменения
- [x] Асинхронный бэкенд на aiogram и SQLAlchemy с подключением к PostgreSQL.
- [x] Определены модели пользователей, групп, каналов и настроек логирования.
- [x] Сервис `UserService` для работы с пользователями, группами и логированием.
- [x] Команды `/start`, `/cancel`, `/birthday`, `/contact` для взаимодействия с пользователем.
- [x] Команда `/group` для управления группами и декоратор проверки членства.
- [x] Логирование событий: middleware, пересылка неизвестных сообщений в группу логов, ответы админа, команды `/setloglevel` и `/getloglevel`.
- [x] Декоратор `role_required` для проверки ролей пользователей.
- [x] Заготовка FSM для обновления контактных данных и описания групп.
- [x] Каркас веб-приложения на FastAPI для работы через webhook.
- [x] Каркас таск-системы.
- [x] Добавлен каркас тайм-менеджера: модель `TimeEntry` и сервис `TimeService` для учёта затраченного времени.
- [x] Подготовлено окружение: установлены зависимости, тесты (22 шт.) проходят; запуск веб-приложения падает из-за отсутствия PostgreSQL.
- [x] Добавлен каркас таск-системы: модель `Task` и сервис `TaskService` для создания и получения задач.
- [x] Переведён `LogLevel` на числовой `IntEnum`, что исправило сравнение уровней логирования и потребовало обновления обработчика `/setloglevel`.
- [x] Добавлен пропущенный импорт `AsyncSession` в сервис Telegram-пользователей и устранены замечания `flake8` в модулях `core`.
- [x] Обновлён `AGENTS.md`: уточнены инструкции и добавлено требование фиксировать изменения и планы в `README.md`.
- [x] Переписаны шаблонные ответы во `web/routes` с учётом нового API Starlette `TemplateResponse`, что устранило предупреждения и проблемы с авторизацией/регистрацией.
- [x] Все обращения к `datetime.utcnow()` заменены на функцию `utcnow()` с поддержкой `datetime.UTC`, что устранило предупреждения о наивных датах.
- [x] Перейдено на lifespan-события FastAPI вместо устаревшего `@app.on_event`.
- [x] В тестах заменён параметр `allow_redirects` на `follow_redirects` для совместимости с новым API `TestClient`.
- [x] Перечисление `GroupType` дополнено типом `group`, что устраняет сбои при обработке обычных чатов Telegram в боте.
- [x] В `AGENTS.md` добавлены инструкции по обязательному запуску PostgreSQL перед тестами и использованию временного файла `.env.test`; `.env.test` внесён в `.gitignore`.
- [x] Добавлены статусы задач (`TaskStatus`) и поддержка в `TaskService`.
- [x] Каркас системы напоминаний: модель `Reminder` и `ReminderService`.
- [x] Добавлена привязка напоминаний к задачам.

### Следующие шаги
- [ ] Поддерживать раздел и следить за соблюдением архитектуры: общий код для `web` и `bot` размещать в `core/`.
- [ ] Проверить запуск приложения с PostgreSQL и подготовить систему миграций БД.
- [x] Добавлены статусы в таск-системе.
- [ ] Развивать таск-систему: добавить напоминания и интеграцию с ботом и веб-интерфейсом.
- [ ] Интегрировать тайм-менеджер с ботом и веб-интерфейсом.
- [ ] Расширить использование `utcnow()` во всех будущих сервисах и моделях, чтобы избежать проблем с часовыми поясами.
- [ ] Устранять появляющиеся предупреждения об устаревшем API и поддерживать зависимости в актуальном состоянии.
- [ ] Проверить остальные типы чатов Telegram и при необходимости дополнить перечисления и обработчики.
- [x] Каркас системы напоминаний.
- [x] Напоминания по таскам.
- [ ] Каркас работы с календарём.
- [ ] Интеграция с Google-календарём.
- [ ] Напоминания по Google-календарю.
- [ ] Реализовать команды `/setfullname`, `/setemail`, `/setphone`, `/setbirthday` и редактирование описаний групп.
- [ ] Веб-интерфейс с авторизацией через Telegram и админ-панелью.
- [ ] Рефакторинг сервисов и логирования, устранение дублирования кода, покрытие тестами.
- [ ] Разделение кода на модули и добавление миграций БД.
- [ ] Тесты и CI/CD для бота и веб-сервера
- [ ] Дополнительные модули: заметки, трекер привычек, учёт финансов, интеграция с внешними задачниками и календарями.

## Миграции
Механизм миграций БД временно не используется. При изменении моделей необходимо
самостоятельно обновлять схему базы данных (например, через `Base.metadata.create_all`) и вносить соответствующие изменения вручную.

## Веб-морда
Веб-приложение на FastAPI предоставляет админ-панель с авторизацией через Telegram.

### Настройка `.env`
Создайте файл `.env` в корне репозитория со следующими переменными:

```dotenv
BOT_TOKEN=123456789:AA...your...token
TELEGRAM_BOT_USERNAME=YourBotName   # БЕЗ @; можно оставить BOT_USERNAME — тоже подхватится
PUBLIC_BASE_URL=http://109.196.99.158:5800  # можно указать домен или IP с портом
SESSION_MAX_AGE=86400
ADMIN_TELEGRAM_IDS=123,456  # список Telegram-ID администраторов через запятую
```

### Telegram Login Widget
1. В @BotFather сделайте `/setdomain` и укажите домен или IP, где открывается `/auth/login` (без схемы).
2. `TELEGRAM_BOT_USERNAME` — без `@`.
3. Если видите «Bot domain invalid», домен страницы не совпадает с заданным у бота или указан username с `@`.

### Запуск
Установите зависимости и запустите сервер:

```bash
pip install -r requirements.txt
uvicorn main:app --host 0.0.0.0 --port 5800
# или
uvicorn web:app --host 0.0.0.0 --port 5800
```

### Навигация
- `/` → редирект на `/auth/login`
- `/auth/login` — кнопка входа Telegram
- `/auth/callback` — проверка подписи, апсерт пользователя → редирект на `/admin`
- `/admin` — админская панель
- `/profile/{telegram_id}` — страница профиля

### Траблшутинг
- «ValidationError / Extra inputs…» → теперь игнорируются (`extra='ignore'`).
- «Field required: TELEGRAM_BOT_USERNAME» → используйте `TELEGRAM_BOT_USERNAME` или `BOT_USERNAME`.
- «Bot domain invalid» → проверьте `/setdomain` и username без `@`.

## Изменение схемы базы данных
Автоматические миграции пока не используются. При первом запуске приложения таблицы
создаются на основе моделей SQLAlchemy. При внесении изменений в схему базы данных
необходимо вручную обновлять существующие базы или пересоздавать их.

## Панель администратора на основе ролей
Роли, определённые в файле `models.py`, определяют доступ к функциям панели администратора:

- `ban` – у меня нет доступа к боту.
- `single` – управляйте только личными данными.
- `multiplayer` – просмотр участников группы.
- `moderator` – отредактируйте информацию об участнике.
- `admin` – полный доступ ко всем функциям.


## Деплой и сервисы
Unit-файлы systemd находятся в [deploy/systemd](deploy/systemd). Они используют переменные окружения из `.env`:

```dotenv
LEONIDBOT_WORKDIR=/sd/tg/LeonidBot
LEONIDBOT_VENV=${LEONIDBOT_WORKDIR}/venv
```

После настройки переменных выполните установку сервисов:

```bash
./deploy/install_services.sh
```

Скрипт скопирует unit-файлы в `/etc/systemd/system/`, выполнит `systemctl daemon-reload`, включит и перезапустит оба сервиса.

Автодеплой на сервер настроен через workflow [deploy.yml](.github/workflows/deploy.yml). Добавьте секреты `VPS_HOST`, `VPS_USER` и `VPS_KEY` с данными SSH. При пуше в `main` репозиторий копируется на сервер, устанавливаются зависимости и перезапускаются сервисы.

